name: Process Data Tebus Web Version

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    # Jadwal setiap hari jam 18:00 UTC (23:00 WIB)
    - cron: '0 18 * * *'
  
  # Optional: trigger saat push ke branch main
  push:
    branches:
      - main
    paths:
      - 'scripts/data_tebus_versi_web.py'
      - '.github/workflows/process_tebus_data.yml'

jobs:
  process-data:
    runs-on: ubuntu-latest
    
    env:
      PYTHON_VERSION: '3.10'
      
    steps:
    - name: ðŸ›Žï¸ Checkout repository
      uses: actions/checkout@v3
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas gspread google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client gspread-dataframe gspread-formatting openpyxl
        
    - name: ðŸ” Setup Google Sheets API credentials
      run: |
        echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}' > service_account.json
        echo "âœ… Service account credentials saved"
        
    - name: ðŸ“§ Setup environment variables
      run: |
        echo "SENDER_EMAIL=${{ secrets.SENDER_EMAIL }}" >> $GITHUB_ENV
        echo "SENDER_EMAIL_PASSWORD=${{ secrets.SENDER_EMAIL_PASSWORD }}" >> $GITHUB_ENV
        echo "RECIPIENT_EMAILS=${{ secrets.RECIPIENT_EMAILS }}" >> $GITHUB_ENV
        echo "GOOGLE_APPLICATION_CREDENTIALS_JSON='$(cat service_account.json)'" >> $GITHUB_ENV
        
    - name: ðŸš€ Run data processing script
      run: |
        python scripts/data_tebus_versi_web.py
        
    - name: ðŸ“¤ Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: error-logs
        path: |
          service_account.json
        retention-days: 1
